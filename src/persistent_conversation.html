<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="videodesk documentation">
    <meta name="author" content="gaspard">
    <meta name="title" content="Call Button - API Documentation | videodesk">
    <meta name="type" content="http://doc.videodesk.com/call_button.html">
    <meta name="url" content="http://doc.videodesk.com/call_button.html">

    <title>Persistent conversation - API Documentation | videodesk</title>

    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="css/app.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

THIS IS A DRAFT


how to acheive persistent conversation ?


<div class="panel panel-warning">
  <div class="panel-heading">This is an UI abstraction component</div>
  <div class="panel-body">
    <p>Abstraction mode must be enabled to use this feature. To learn more about this, please refer to the <a href="abstract_ui.html">user interface abstraction documentation</a>.</p>
  </div>
</div>

<h2>Feature description</h2>

<p>
  Persistent conversation is a bundle of features allowing offline messenging.
  It allows the webuser to send the messages to the agent while the agent is not available and the webuser to read the messages that the agent sent her/him while she/he was not connected to the page.
</p>

<p>
  Thus, this feature involves a set of features such as webuser authentification (which is based on the previous webuser_uid), sending offline messages into an inbox, displaying notifications, having messages status (read/unread) and displaying an history of previous online and offline conversations.
</p>

<h3>Required configuration</h3>

<p>
  This feature is based on the messaging feature, please <b>enable offline messaging</b>.
</p>

<ul>
  <li>Connect as and account manager into the back-office,</li>
  <li>Browse to website configuration > conversation,</li>
  <li>In the <b>Chat Window Offline Behavior</b>,</li>
  <li>
    For <b>If a call is not possible:</b>, check<b>
    "Display a message form, the visitor can send an email to the picked agent or all the agents"</b>.
  </li>
</ul>


<h3>API endpoints</h3>
<p>Persistent conversation integration with offline messaging and abstract ui regroups a set of API elements:</p>
<ul>
  <li>Webuser identification across several browsers</li>
  <li>Checking if the webuser has unread messages</li>
  <li>Accessing webuser's messages and marking all messages as read</li>
  <li>Sending a message to the agent</li>
</ul>

<h2>webuser tracking</h2>

<p>
  Webusers are identified by webuser_uid. This randomly gnerated unique identifier is created locally on the webuser machine. During the first call, the webuser_uid is stored in the back-office and available for the agent.
</p>

<p>
  The webuser_uid is stored in a cookie.
</p>

<p>
  Before the first call, or message sent by the webuser, it does not exist to the agent. The first contact has to be made by the agent.
</p>

<p>
  In some cases, a developer may wish to identify the same webuser across several devices or browsers, there is a way to set the webuser_uid manually.
</p>

<p>
  webuser_uid is generated by the front script unless specified otherwise. To force a webuser_uid, you can use <code>window._videodesk.webuser_uid</code>
</p>



<h2>Check pending messages</h2>

<p>
  The messaging system works as an inbox, to know if the webuser has unread pending messages, please use the <code>has_unread_message_webuser</code>API endpoint.
</p>

<pre>
  GET /conversation/has_unread_message_webuser/{site_uid}/{webuser_uid}
</pre>

<pre>
  let url = '//' + _vdk.parameters['globals']['host'] +
			'/conversation/has_unread_message_webuser/' +
			_videodesk.uid + '/' + _vdk.getContextParameter('webuser_uid')
</pre>

<p>
  This will return a JSONP string containing an Array of unread messages &amp; agent_uid
</p>

<pre class="code">
  [
    {
      unread_messages: 5,
      agent_uid: 'f918271889bcaa122'
    }
  ]
</pre>

<p>
  In this case, it means that the webuser has 3 unread messages from this agent_uid.
</p>


<h3>Fair use</h3>
<p>
  It is useless to check this feature each X seconds. Don't forget, if the agent were sending messages, then (s)he should be online.
</p>
<p>
  This would be useless, waist bandwidth, slow down webuser experience and consume many server resources.
</p>
<p>
  Instead, please check for new messages on page load, that's largely enough, messages are being sent while the webuser is offline.
</p>


<h2>Get conversation</h2>

<pre>
/**
 * getConversationHistory
 * @param {string} conversation.webuser_uid
 * @param {string} conversation.site_uid
 * @param {string} conversation.agent_uid
 * @param {string} conversation.lang (optional)
 * @callback {xhrData} xhr.data
 */
_vdk.tool.getConversationHistory

'https://' + _vdk.parameters.globals.bo_url +
		'/conversation' +
		'/' + conversation.site_uid +
		'/'+ conversation.agent_uid +
		'/' + conversation.webuser_uid +
		'?lang=' + theLang;
</pre>

Be careful, this will mark all the messages as read


<h2>Sending messages</h2>

<p>
  Messages can be sent using the messaging API
</p>

<code>
url = '//' + _vdk.parameters['globals']['host'] + '/conversation/send_message?messageType=text&mode=modern&module_from=front&agentUid=' + agent_uid;
</code>


<div class="panel panel-warning">
  <div class="panel-heading">This is an UI abstraction component</div>
  <div class="panel-body">
    <p>This API endpoint may most likely change in a near future.</p>
  </div>
</div>
